<html>
    <head>
        <meta charset="utf-8">
        <meta name="robots" content="noindex,nofollow,noarchive">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>bluesky viewer</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    </head>
    <body style="margin: 2%;">
        @<input type="text" id="handle" size="10">.bsky.social
        <input type="button" id="btn" value="get"><br>
        <span id="error" style="color: red;"></span><br><br>
        <div id="timeline"></div>
        <script>
            document.getElementById("btn").addEventListener('click', async function() {
                document.getElementById("error").innerText = "";
                const handle = document.getElementById("handle").value + ".bsky.social";
                document.getElementById("timeline").innerHTML = "<p>loading for @" + handle + "...</p>";
                if (!handle) {
                    document.getElementById("error").innerText = "invalid handle.";
                    return;
                }
                const did = await getDid(handle);
                if (!did) {
                    return;
                }
                const feeds = await getAuthorFeed(handle, did);
                if (!feeds) {
                    return;
                }
                const timeline = await buildTimeline(feeds, did);
                document.getElementById("timeline").innerHTML = timeline;
            }, false);
            async function getAuthorFeed(handle, did) {
                try {
                    const url = "https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=" + encodeURI(did) + "&filter=posts_and_author_threads&includePins=true&limit=30";
                    const response = await fetch(url);
                    if (!response) {
                        return;
                    }
                    const feeds = await response.json();
                    return feeds;
                } catch(e) {
                    document.getElementById("error").innerText = "cannot retrieve feeds.";
                }
            }
            async function getDid(handle) {
                try {
                    const url = "https://" + handle + "/.well-known/atproto-did";
                    const response = await fetch(url);
                    return await response.text();
                } catch (e) {
                    document.getElementById("error").innerText = "cannot retrieve did.";
                }
            }
            async function buildTimeline(feeds, did) {
                let timeline = '';
                Object.keys(feeds.feed).forEach(function(i) {
                    if (feeds.feed[i].post.author.did !== did) {
                        timeline = timeline + '<svg fill="none" width="13" height="13" viewBox="0 0 24 24" style="color: rgb(66, 87, 108); margin-right: 3px;"><path fill="hsl(211, 24%, 34.2%)" fill-rule="evenodd" clip-rule="evenodd" d="M17.957 2.293a1 1 0 1 0-1.414 1.414L17.836 5H6a3 3 0 0 0-3 3v3a1 1 0 1 0 2 0V8a1 1 0 0 1 1-1h11.836l-1.293 1.293a1 1 0 0 0 1.414 1.414l2.47-2.47a1.75 1.75 0 0 0 0-2.474l-2.47-2.47ZM20 12a1 1 0 0 1 1 1v3a3 3 0 0 1-3 3H6.164l1.293 1.293a1 1 0 1 1-1.414 1.414l-2.47-2.47a1.75 1.75 0 0 1 0-2.474l2.47-2.47a1 1 0 0 1 1.414 1.414L6.164 17H18a1 1 0 0 0 1-1v-3a1 1 0 0 1 1-1Z"></path></svg>&nbsp;&nbsp;';
                    }
                    timeline = timeline +
                        "<img src='" + feeds.feed[i].post.author.avatar + "' width='20'>&nbsp;&nbsp;" +
                        "<span style='font-weight: bold;'>" + feeds.feed[i].post.author.displayName + "</span>" +
                        "<span style='color: rgb(111, 134, 159);'> @" + feeds.feed[i].post.author.handle + "</span>" +
                        "<br>" +
                        feeds.feed[i].post.record.text.replace("\n","<br>") + "<br>";
                    if (feeds.feed[i].post.embed) {
                        timeline = timeline + "<br>";
                        if (feeds.feed[i].post.embed.images) {
                            feeds.feed[i].post.embed.images.forEach(function(image) {
                                if (image.thumb !== undefined) {
                                    timeline = timeline + 
                                        "<a href='" + image.fullsize + "' target='_blank'>" +
                                        "<img src='" + image.thumb + "' width='300'>" +
                                        "</a><br>"
                                }
                            });
                        }
                        if (feeds.feed[i].post.embed.external) {
                            timeline = timeline +
                                "<a href='" + feeds.feed[i].post.embed.external.uri + "' target='_blank'>" +
                                feeds.feed[i].post.embed.external.title;
                            if (feeds.feed[i].post.embed.external.thumb !== undefined) {
                                timeline = timeline + "<br><img src='" + feeds.feed[i].post.embed.external.thumb + "' width='300'>";
                            }
                            timeline = timeline + "</a><br>";
                        }
                    }
                    timeline = timeline + "<br>";
                    if (feeds.feed[i].post.repostCount > 0) {
                        timeline = timeline +
                            '<svg fill="none" width="13" height="13" viewBox="0 0 24 24" style="color: rgb(66, 87, 108); margin-right: 3px;"><path fill="hsl(211, 24%, 34.2%)" fill-rule="evenodd" clip-rule="evenodd" d="M17.957 2.293a1 1 0 1 0-1.414 1.414L17.836 5H6a3 3 0 0 0-3 3v3a1 1 0 1 0 2 0V8a1 1 0 0 1 1-1h11.836l-1.293 1.293a1 1 0 0 0 1.414 1.414l2.47-2.47a1.75 1.75 0 0 0 0-2.474l-2.47-2.47ZM20 12a1 1 0 0 1 1 1v3a3 3 0 0 1-3 3H6.164l1.293 1.293a1 1 0 1 1-1.414 1.414l-2.47-2.47a1.75 1.75 0 0 1 0-2.474l2.47-2.47a1 1 0 0 1 1.414 1.414L6.164 17H18a1 1 0 0 0 1-1v-3a1 1 0 0 1 1-1Z"></path></svg>&nbsp;'+
                            "<span style='color: rgb(111, 134, 159);'>" + feeds.feed[i].post.repostCount + "</span>&nbsp;&nbsp;";
                    }
                    if (feeds.feed[i].post.likeCount > 0) {
                        timeline = timeline +
                            '<svg fill="none" width="18" viewBox="0 0 24 24" height="18" style="color: rgb(111, 134, 159); pointer-events: none;"><path fill="hsl(211, 20%, 53%)" fill-rule="evenodd" clip-rule="evenodd" d="M16.734 5.091c-1.238-.276-2.708.047-4.022 1.38a1 1 0 0 1-1.424 0C9.974 5.137 8.504 4.814 7.266 5.09c-1.263.282-2.379 1.206-2.92 2.556C3.33 10.18 4.252 14.84 12 19.348c7.747-4.508 8.67-9.168 7.654-11.7-.541-1.351-1.657-2.275-2.92-2.557Zm4.777 1.812c1.604 4-.494 9.69-9.022 14.47a1 1 0 0 1-.978 0C2.983 16.592.885 10.902 2.49 6.902c.779-1.942 2.414-3.334 4.342-3.764 1.697-.378 3.552.003 5.169 1.286 1.617-1.283 3.472-1.664 5.17-1.286 1.927.43 3.562 1.822 4.34 3.764Z"></path></svg>&nbsp;' +
                            "<span style='color: rgb(111, 134, 159);'>" + feeds.feed[i].post.likeCount + "</span>&nbsp;&nbsp;";
                    }
                    timeline = timeline + "<span style='color: rgb(111, 134, 159);'>(" + feeds.feed[i].post.record.createdAt + ")</span><br><hr>";
                });
                return timeline;
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    </body>
</html>
